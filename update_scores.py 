import json
import os
from github import Github

# GitHub Token & Repo Name
GITHUB_TOKEN = os.getenv("GITHUB_TOKEN")
REPO_NAME = os.getenv("REPO_NAME")

# Initialize GitHub API
g = Github(GITHUB_TOKEN)
repo = g.get_repo(REPO_NAME)

# Load existing scores
SCORES_FILE = "scores.json"
try:
    with open(SCORES_FILE, "r") as f:
        scores = json.load(f)
except (FileNotFoundError, json.JSONDecodeError):
    scores = {}

# Get merged PRs in the last 24 hours
merged_prs = repo.get_pulls(state="closed", sort="updated", direction="desc")
updated_users = set()

for pr in merged_prs:
    if pr.merged:  # Check if PR is actually merged
        username = pr.user.login
        updated_users.add(username)

        # Add 3 points per merged PR
        scores[username] = scores.get(username, 0) + 3

# Save updated scores
with open(SCORES_FILE, "w") as f:
    json.dump(scores, f, indent=4)

print(f"Updated scores: {scores}")